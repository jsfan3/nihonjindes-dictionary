name: Italian translations only

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce PR touches only it_words + meta (no .gz, pretty JSON, meta updated)
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"

          mapfile -t CHANGED_STATUS < <(git diff --name-status "$BASE_SHA" "$HEAD_SHA" | sed '/^\s*$/d' || true)

          if [ "${#CHANGED_STATUS[@]}" -eq 0 ]; then
            echo "No changed files detected."
            exit 0
          fi

          echo "Changed files (name-status):"
          printf ' - %s\n' "${CHANGED_STATUS[@]}"

          ITCOMMON_META="data/lang/it_common/meta.json"

          is_allowed() {
            local f="$1"
            case "$f" in
              data/lang/it_common/meta.json) return 0 ;;
              data/lang/it_common/it_words_*.json) return 0 ;;
              *) return 1 ;;
            esac
          }

          is_forbidden_compressed() {
            local f="$1"
            case "$f" in
              data/lang/it_common/it_words_*.json.gz) return 0 ;;
              data/lang/it_common/it_words_*.jsonl.gz) return 0 ;;
              *) return 1 ;;
            esac
          }

          check_pretty_json() {
            local f="$1"
            if [ ! -f "$f" ]; then
              echo "::error file=$f::Expected file to exist for pretty-print validation."
              FAIL=1
              return
            fi
            local lines
            lines="$(wc -l < "$f" | tr -d ' ')"
            if [ "${lines:-0}" -le 10 ]; then
              echo "::error file=$f::JSON must be pretty printed (not a single line)."
              FAIL=1
            fi
          }

          FAIL=0
          NEEDS_META=0
          META_TOUCHED=0

          # Hard rule: the repo must not contain tracked compressed italian translation files
          FOUND_COMPRESSED="$(git ls-files -- 'data/lang/it_common/it_words_*.json.gz' 'data/lang/it_common/it_words_*.jsonl.gz' || true)"
          if [ -n "$FOUND_COMPRESSED" ]; then
            echo "::error::Compressed Italian translation files are forbidden. Remove these tracked files:"
            echo "$FOUND_COMPRESSED"
            FAIL=1
          fi

          for line in "${CHANGED_STATUS[@]}"; do
            status="$(echo "$line" | awk '{print $1}')"

            # Handle rename/copy (Rxxx/Cxxx old new)
            if [[ "$status" =~ ^R ]] || [[ "$status" =~ ^C ]]; then
              old_path="$(echo "$line" | awk '{print $2}')"
              new_path="$(echo "$line" | awk '{print $3}')"

              # "nient'altro": both sides must be allowed
              if ! is_allowed "$old_path"; then
                echo "::error file=$old_path::Only these files may be changed: data/lang/it_common/it_words_*.json and data/lang/it_common/meta.json."
                FAIL=1
              fi
              if ! is_allowed "$new_path"; then
                echo "::error file=$new_path::Only these files may be changed: data/lang/it_common/it_words_*.json and data/lang/it_common/meta.json."
                FAIL=1
              fi

              if is_forbidden_compressed "$new_path"; then
                echo "::error file=$new_path::Compressed Italian translation files (.json.gz/.jsonl.gz) are forbidden."
                FAIL=1
              fi

              if [[ "$new_path" == *.json ]]; then
                check_pretty_json "$new_path"
              fi

              if [[ "$new_path" == "$ITCOMMON_META" ]]; then
                META_TOUCHED=1
              fi
              case "$new_path" in
                data/lang/it_common/it_words_*.json) NEEDS_META=1 ;;
              esac

              continue
            fi

            # Normal A/M/D/etc
            path="$(echo "$line" | awk '{print $2}')"

            if ! is_allowed "$path"; then
              echo "::error file=$path::Only these files may be changed: data/lang/it_common/it_words_*.json and data/lang/it_common/meta.json."
              FAIL=1
              continue
            fi

            if is_forbidden_compressed "$path"; then
              echo "::error file=$path::Compressed Italian translation files (.json.gz/.jsonl.gz) are forbidden."
              FAIL=1
            fi

            # Pretty print check only if file exists in HEAD (not deletions)
            if [ "$status" != "D" ] && [[ "$path" == *.json ]]; then
              check_pretty_json "$path"
            fi

            if [[ "$path" == "$ITCOMMON_META" ]]; then
              META_TOUCHED=1
            fi
            case "$path" in
              data/lang/it_common/it_words_*.json) NEEDS_META=1 ;;
            esac
          done

          # If any it_words_* touched (including deletions/renames), require meta.json touched too
          if [ "$NEEDS_META" -eq 1 ] && [ "$META_TOUCHED" -eq 0 ]; then
            echo "::error file=$ITCOMMON_META::Any change to it_words_*.json requires updating meta.json in the same PR."
            FAIL=1
          fi

          exit $FAIL
